<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper

		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"

		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
		
<mapper namespace="com.bside.BSIDE.contents.persistence.QuestionMapper">
	
	<!-- 질문 저장 -->
	<insert id="insertQuestion" parameterType="com.bside.BSIDE.contents.domain.QuestionDto">
		INSERT INTO
			bside.question(
			q_category,
			q_writer,
			q_created_at
		)
		VALUES(
				  #{category},
				  #{qWriter},
				  now()
			  )
	</insert>

	<!--  질문 리스트 조회 -->
	<select id="getQuestionByCategory" resultType="com.bside.BSIDE.contents.domain.QuestionDto" parameterType="string">
		SELECT Q.q_no as qNo, Q.q_question as qQuestion, Q.q_category as qCategory, Q.q_writer as qWriter, Q.q_created_at as qCreatedAt
		FROM bside.question Q 
		LEFT OUTER JOIN bside.answer A ON Q.q_no = A.q_no
		WHERE A.q_no IS NULL AND Q.q_category = #{category}
		ORDER BY RAND() LIMIT 4;
	</select>
	
	<!-- qNo에 해당하는 질문 조회 -->
	<select id="getQuestionByPNO" resultType="com.bside.BSIDE.contents.domain.QuestionDto" parameterType="int">
	    SELECT q_no as qNo, q_question as qQuestion
	    FROM bside.question
	    WHERE q_no = #{pNo}
	</select>	
	
	<!-- 금일 잔여 답변 개수 조회 -->
	<select id="countUnansweredQuestions" resultType="int">
		SELECT 3-COUNT(*) 
		FROM bside.answer 
		WHERE a_check = false 
		AND YEAR(a_created_at) = YEAR(CURRENT_DATE()) 
		AND MONTH(a_created_at) = MONTH(CURRENT_DATE()) 
		AND DAY(a_created_at) = DAY(CURRENT_DATE())
		AND a_writer = #{writer}
    </select>
    
    <!-- 이번달에 답변한 질문 개수 조회 -->
    <select id="countAnsweredQuestionsThisMonth" resultType="int">
	    SELECT COUNT(*) 
	    FROM bside.question q
	    INNER JOIN bside.answer a ON q.q_no = a.q_no
	    WHERE YEAR(a.a_created_at) = YEAR(CURRENT_DATE())
	    AND MONTH(a.a_created_at) = MONTH(CURRENT_DATE())
	    AND a.a_writer = #{writer}
	</select>
	
	<!-- 오늘 답변한 질문 개수 조회 -->
    <select id="countAnsweredQuestionsToday" resultType="int">
	    SELECT COUNT(*) 
	    FROM bside.question q
	    INNER JOIN bside.answer a ON q.q_no = a.q_no
	    WHERE YEAR(a.a_created_at) = YEAR(CURRENT_DATE())
	    AND MONTH(a.a_created_at) = MONTH(CURRENT_DATE())
	    AND DAY(a.a_created_at) = DAY(CURRENT_DATE())
	    AND a.a_writer = #{writer}
	</select>
    
    <!-- 선택한 월에 답변한 질문 개수 조회 -->
	<select id="countAnsweredQuestionsByMonth" resultType="com.bside.BSIDE.contents.domain.CountAnsweredQuestionsByMonthDto">
	    SELECT COUNT(*) AS count, #{email} AS email, CONCAT(#{year}, '-', #{month}) AS date 
	    FROM bside.answer a
	    LEFT OUTER JOIN bside.question q ON a.q_no = q.q_no
	    WHERE q.q_no IS NOT NULL
	    AND a.a_check = TRUE 
	    AND YEAR(a.a_created_at) = #{year}
	    AND MONTH(a.a_created_at) = #{month}
	    AND a.a_writer = #{email} 
	</select>
	
	<select id="getQuestionsAndAnswersByMonthAndEmail" resultType="com.bside.BSIDE.contents.domain.QuestionAndAnswerDto">
    SELECT q.q_question AS question,
           MAX(a.a_answer_content) AS answer,
           COUNT(*) AS answerCount,
           DATE(a.a_created_at) AS date
    FROM bside.answer a
    INNER JOIN bside.question q ON a.q_no = q.q_no
    WHERE a.a_writer = #{email}
    AND a.a_check = TRUE
    AND YEAR(a.a_created_at) = YEAR(#{date})
    AND MONTH(a.a_created_at) = MONTH(#{date})
    GROUP BY q.q_no, DATE(a.a_created_at)
</select>
    
    <!-- 선택한 년,월,일에 답변한 질문 조회 -->
    <select id="getQuestionsAndAnswersByDayAndEmail" resultType="com.bside.BSIDE.contents.domain.QuestionAndAnswerDto">
        SELECT q.q_question AS question, a.a_answer_content AS answer
        FROM bside.answer a
        INNER JOIN bside.question q ON a.q_no = q.q_no
        WHERE a.a_writer = #{email}
        AND a.a_check = TRUE
        AND YEAR(a.a_created_at) = YEAR(#{date}) 
        AND MONTH(a.a_created_at) = MONTH(#{date})
        AND DAY(a.a_created_at) = DAY(#{date})
    </select>
	
</mapper>